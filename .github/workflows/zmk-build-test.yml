name: ZMK Firmware Build Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'app/**'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'app/**'
      - '.github/workflows/**'

jobs:
  build-test:
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:4.1
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # 基础编译测试
          - board: nice_nano_v2
            shield: ""
          - board: nice_nano_v2
            shield: "reviung41"
          - board: nice_nano_v2
            shield: "corne"
          
          # SSD1306 显示测试
          - board: nice_nano_v2
            shield: "oled_shield"
            cmake_args: "-DCONFIG_ZMK_DISPLAY=y"
          - board: nice_nano_v2
            shield: "corne"
            cmake_args: "-DCONFIG_ZMK_DISPLAY=y"
          
          # RGB 测试
          - board: nice_nano_v2
            shield: "corne_left"
            cmake_args: "-DCONFIG_ZMK_RGB_UNDERGLOW=y"
          
          # BLE 测试
          - board: nice_nano_v2
            cmake_args: "-DCONFIG_ZMK_BLE=y"
          
          # 分体键盘测试
          - board: nice_nano_v2
            shield: "split_revealing"
            cmake_args: "-DCONFIG_ZMK_SPLIT=y"
            
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-zmk-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-zmk-
            
      - name: Initialize workspace
        run: |
          west init -l app
          west update --fetch-opt=--filter=tree:0
          
      - name: Export Zephyr CMake package
        run: west zephyr-export
        
      - name: Build ${{ matrix.board }} ${{ matrix.shield }}
        run: |
          if [ -z "${{ matrix.shield }}" ]; then
            shield_arg=""
          else
            shield_arg="-DSHIELD=\"${{ matrix.shield }}\""
          fi
          
          if [ -z "${{ matrix.cmake_args }}" ]; then
            cmake_args=""
          else
            cmake_args="${{ matrix.cmake_args }}"
          fi
          
          west build app -p -b ${{ matrix.board }} -- $shield_arg $cmake_args
          
      - name: Check build artifacts
        run: |
          echo "Build artifacts:"
          ls -la build/zephyr/zmk.* 2>/dev/null || echo "No artifacts found"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zmk-${{ matrix.board }}-${{ matrix.shield || 'base' }}
          path: |
            build/zephyr/zmk.uf2
            build/zephyr/zmk.hex
          retention-days: 7

  display-build-test:
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:4.1
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-zmk-display-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-zmk-display-
            
      - name: Initialize workspace
        run: |
          west init -l app
          west update --fetch-opt=--filter=tree:0
          
      - name: Export Zephyr CMake package
        run: west zephyr-export
        
      - name: Build with SSD1306 display enabled
        run: |
          west build app -p -b nice_nano_v2 -- -DSHIELD="oled_shield" -DCONFIG_ZMK_DISPLAY=y
          
      - name: Verify display configuration
        run: |
          echo "Checking if display was compiled..."
          if grep -q "CONFIG_ZMK_DISPLAY=y" build/.config 2>/dev/null; then
            echo "✓ Display enabled"
          else
            echo "✗ Display not enabled"
            exit 1
          fi
          
      - name: Build with RGB underglow
        run: |
          west build app -p -b nice_nano_v2 -- -DSHIELD="corne" -DCONFIG_ZMK_RGB_UNDERGLOW=y
          
      - name: Build all features combined
        run: |
          west build app -p -b nice_nano_v2 -- \
            -DSHIELD="corne" \
            -DCONFIG_ZMK_DISPLAY=y \
            -DCONFIG_ZMK_RGB_UNDERGLOW=y \
            -DCONFIG_ZMK_BLE=y

  nightly-build:
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:4.1
    if: github.event_name == 'schedule'
    
    strategy:
      fail-fast: false
      matrix:
        board:
          - nice_nano_v2
          - nice_nano
          - nice_view_adapter
          - qmk_focus
          - sparkfun_nrf52840_mini
          
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-zmk-nightly-${{ matrix.board }}-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-zmk-nightly-${{ matrix.board }}-
            
      - name: Initialize workspace
        run: |
          west init -l app
          west update --fetch-opt=--filter=tree:0
          
      - name: Export Zephyr CMake package
        run: west zephyr-export
        
      - name: Build ${{ matrix.board }}
        run: west build app -p -b ${{ matrix.board }}

  local-build-test:
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:4.1
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Build all app source files
        run: |
          echo "Testing compilation of all display-related files..."
          
          # Test display module
          echo "=== Testing display module ==="
          west build app -p -b nice_nano_v2 -- -DSHIELD="oled_shield" -DCONFIG_ZMK_DISPLAY=y
          
          # List compiled objects
          echo ""
          echo "=== Compiled objects (display) ==="
          find build/zephyr -name "*.o" | grep -E "(display|oled)" | head -20 || echo "No display objects found"
          
          echo ""
          echo "=== Build successful! ==="
