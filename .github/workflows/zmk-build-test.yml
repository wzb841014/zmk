name: ZMK Build Test

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:4.1

    strategy:
      fail-fast: false
      matrix:
        include:
          # 基础编译
          - board: nice_nano_v2
            shield: ""
          # 带显示
          - board: nice_nano_v2
            shield: "nice_view_adapter"
            cmake_args: "-DCONFIG_ZMK_DISPLAY=y"
          # 带RGB
          - board: nice_nano_v2
            shield: "corne"
            cmake_args: "-DCONFIG_ZMK_RGB_UNDERGLOW=y"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
          key: ${{ runner.os }}-zmk-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-zmk-

      - name: Initialize workspace
        run: |
          west init -l app
          west update --fetch-opt=--filter=tree:0

      - name: Export Zephyr
        run: west zephyr-export

      - name: Build ${{ matrix.board }} ${{ matrix.shield }}
        run: |
          if [ -z "${{ matrix.shield }}" ]; then
            shield_arg=""
          else
            shield_arg="-DSHIELD=${{ matrix.shield }}"
          fi

          if [ -z "${{ matrix.cmake_args }}" ]; then
            cmake_args=""
          else
            cmake_args="${{ matrix.cmake_args }}"
          fi

          west build app -p -b ${{ matrix.board }} -- $shield_arg $cmake_args

      - name: Verify output
        run: |
          ls -la build/zephyr/zmk.* 2>/dev/null && echo "✅ Build successful!" || echo "❌ No artifacts found"
